<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø´ÙŠØ® Ø¹Ø·Ø§ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #1b4332; --g: #d4af37; --bg: #f4f7f6; }
        body { background: var(--bg); font-family: 'Tajawal', sans-serif; margin: 0; direction: rtl; }
        header { background: var(--p); color: var(--g); padding: 25px; text-align: center; border-bottom: 5px solid var(--g); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; padding: 25px; max-width: 1100px; margin: auto; }
        .card { background: white; border-radius: 20px; padding: 25px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--g); }
        .card h2 { font-size: 1rem; color: var(--p); }

        .notification-badge { display: none; position: absolute; top: 15px; right: 15px; background: #ff4757; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(255, 71, 87, 0.6); z-index: 10; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 800px; margin: 3vh auto; padding: 30px; border-radius: 25px; position: relative; max-height: 90vh; overflow-y: auto; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        .btn-p { background: var(--p); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-wa { background: #25D366; color: white; padding: 5px 10px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; display: inline-block; font-weight: bold;}
        
        .msg-box { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 10px; border-right: 5px solid var(--g); background: #fff; }
        .strike-tag { background: #ff4757; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; }
        .action-btn { padding: 5px 15px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; margin: 2px; }

        .circle-header { background: var(--g); color: var(--p); padding: 10px; margin-top: 20px; border-radius: 10px; font-weight: bold; text-align: center; }
        .student-profile { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 12px; background: #fafafa; text-align: right; }
        .profile-row { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }

        .loading { display: none; color: var(--g); font-weight: bold; margin: 10px 0; text-align: center; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; border-radius: 50px; color: white; display: none; z-index: 3000; }

        .print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="toast"></div>
<div id="print-area" class="print-area"><div id="print-content"></div></div>
<header><h1>Ù†Ø¸Ø§Ù… Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø´ÙŠØ® Ø¹Ø·Ø§ Ø§Ù„Ø±Ù‚Ù…ÙŠ</h1></header>

<div class="main-grid no-print">
    <div class="card" onclick="openModal('att-modal')"><h2>ğŸ†” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2></div>
    <div class="card" onclick="openModal('search-modal')"><h2>ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…ØªÙ‚Ø¯Ù…</h2></div>
    <div class="card" onclick="openModal('absent-modal')"><h2>ğŸš« ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨</h2></div>
    <div class="card" onclick="openModal('reg-modal')"><h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2></div>
    <div class="card" onclick="openModal('admin-review-modal'); loadBlocked();"><h2>âš ï¸ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ÙˆÙØµÙ„</h2></div>
    
    <div class="card" onclick="openModal('messages-modal'); loadMessages();">
        <div id="msg-badge" class="notification-badge"></div>
        <h2>ğŸ“© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h2>
    </div>

    <div class="card" onclick="openModal('broadcast-modal')" style="background: #fff3e0; border: 1px dashed var(--g);">
        <h2>ğŸ“¢ ØªØ¹Ù…ÙŠÙ… Ù„Ù„Ø­Ù„Ù‚Ø§Øª</h2>
    </div>
</div>

<div id="search-modal" class="modal"><div class="modal-content">
    <h3 class="no-print">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ø·ÙˆØ±</h3>
    <input type="text" id="s-query" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ (Ø§Ù„Ø§Ø³Ù…ØŒ IDØŒ Ø§Ù„ØµÙØŒ Ø£Ùˆ 'Ù†Ø¹Ù…' Ù„Ù„Ø£ÙŠØªØ§Ù…)">
    <div style="display: flex; gap: 10px;" class="no-print">
        <button class="btn-p" onclick="runSearch('brief')">Ø¨Ø·Ø§Ù‚Ø© Ù…Ø®ØªØµØ±Ø©</button>
        <button class="btn-p" style="background:#2d3436" onclick="runSearch('full')">Ø¨Ø·Ø§Ù‚Ø© ÙƒØ§Ù…Ù„Ø©</button>
    </div>
    <div id="s-load" class="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... â³</div>
    <div id="s-res"></div>
    <button class="btn-p no-print" id="btn-p-s" style="display:none; background: #666;" onclick="doPrint('s-res')">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
    <button class="btn-p no-print" style="background:#999" onclick="closeModal('search-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="messages-modal" class="modal"><div class="modal-content">
    <h3>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
    <div id="msg-load" class="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    <div id="msg-list" style="margin-top:15px;"></div>
    <button class="btn-p" style="background:#999" onclick="closeModal('messages-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="broadcast-modal" class="modal"><div class="modal-content">
    <h3>Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù…ÙŠÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h3>
    <textarea id="bc-text" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù‡Ù†Ø§..."></textarea>
    <button class="btn-p" onclick="sendBroadcast()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ø§Ù„Ø¢Ù†</button>
    <button class="btn-p" style="background:#999" onclick="closeModal('broadcast-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="admin-review-modal" class="modal"><div class="modal-content">
    <h3>Ø·Ù„Ø§Ø¨ Ù…ØªØ¬Ø§ÙˆØ²ÙŠÙ† (ØºÙŠØ§Ø¨ 3 Ø£ÙŠØ§Ù… Ø£Ùˆ Ø­Ø¸Ø±)</h3>
    <div id="blocked-load" class="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</div>
    <div id="blocked-list"></div>
    <button class="btn-p" style="background:#999" onclick="closeModal('admin-review-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="att-modal" class="modal"><div class="modal-content">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <input type="number" id="att-id" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø·Ø§Ù„Ø¨">
    <div id="att-load" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... â³</div>
    <button class="btn-p" onclick="doAttendance()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</button>
    <button class="btn-p" style="background:#999" onclick="closeModal('att-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="absent-modal" class="modal"><div class="modal-content">
    <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h3>
    <input type="text" id="abs-c" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© (Ø£Ùˆ Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙƒÙ„)">
    <input type="date" id="abs-date">
    <button class="btn-p" onclick="runAbsent()">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    <div id="abs-load" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª... â³</div>
    <div id="abs-res"></div>
    <button class="btn-p no-print" id="btn-p-a" style="display:none; background: #666;" onclick="doPrint('abs-res')">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
    <button class="btn-p no-print" style="background:#999" onclick="closeModal('absent-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<div id="reg-modal" class="modal"><div class="modal-content">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input id="r-id" placeholder="ID"> <input id="r-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input id="r-class" placeholder="Ø§Ù„ØµÙ"> <input id="r-circle" placeholder="Ø§Ù„Ø­Ù„Ù‚Ø©">
        <input id="r-father" placeholder="Ø§Ù„Ø£Ø¨"> <input id="r-mother" placeholder="Ø§Ù„Ø£Ù…">
        <input id="r-dob" type="date"> <input id="r-phone" placeholder="ÙˆØ§ØªØ³Ø§Ø¨">
        <input id="r-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="grid-column: span 2;">
        <input id="r-family" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø±Ø©">
        <select id="r-orphan" style="grid-column: span 2;"><option value="Ù„Ø§">ÙŠØªÙŠÙ…: Ù„Ø§</option><option value="Ù†Ø¹Ù…">ÙŠØªÙŠÙ…: Ù†Ø¹Ù…</option></select>
    </div>
    <button class="btn-p" onclick="doRegister()">Ø­ÙØ¸</button>
    <button class="btn-p" style="background:#999" onclick="closeModal('reg-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
</div></div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzo4Z6YhurP8puWYxrDJ8MCT5wbvOwh8kozG_GaDpvMs4jxK0SPNwJZFM56XzD8R3XY/exec";

    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function msg(t, c) { const s = document.getElementById('toast'); s.innerText = t; s.style.background = c; s.style.display = 'block'; setTimeout(() => s.style.display='none', 3000); }

    // ÙˆØ¸ÙŠÙØ© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª (ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§)
    // ÙˆØ¸ÙŠÙØ© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    async function runAbsent() {
        const circle = document.getElementById('abs-c').value;
        const date = document.getElementById('abs-date').value;
        if(!date) return msg("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®", "orange");

        document.getElementById('abs-load').style.display = 'block';
        document.getElementById('abs-res').innerHTML = "";

        try {
            const res = await fetch(`${SCRIPT_URL}?action=searchStudent&query=`); 
            const students = await res.json();
            
            let h = `<table class="report-table"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ù„Ù‚Ø©</th><th>ØªÙˆØ§ØµÙ„</th></tr>`;
            let count = 0;

            students.forEach(s => {
                if(!circle || s.circle == circle) {
                    // ØªØ¬Ù‡ÙŠØ² Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ´ÙÙŠØ±Ù‡ Ù„ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
                    const messageText = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø¥Ù† Ø§Ø¨Ù†ÙƒÙ… (${s.name}) Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙŠÙˆÙ….`;
                    const encodedMsg = encodeURIComponent(messageText);
                    const waLink = `https://wa.me/${s.phone}?text=${encodedMsg}`;

                    h += `<tr>
                        <td>${s.name}</td>
                        <td>${s.circle}</td>
                        <td><a class="btn-wa" href="${waLink}" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨</a></td>
                    </tr>`;
                    count++;
                }
            });

            document.getElementById('abs-res').innerHTML = count ? h + "</table>" : "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨.";
            document.getElementById('btn-p-a').style.display = count ? 'block' : 'none';
        } catch(e) {
            msg("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª", "red");
        } finally {
            document.getElementById('abs-load').style.display = 'none';
        }
    }

    async function checkNewMessages() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getTeacherMessages`);
            const data = await res.json();
            const lastSeenCount = parseInt(localStorage.getItem('lastMsgCount')) || 0;
            document.getElementById('msg-badge').style.display = data.length > lastSeenCount ? 'block' : 'none';
        } catch(e) {}
    }

    async function loadMessages() {
        document.getElementById('msg-load').style.display = 'block';
        const res = await fetch(`${SCRIPT_URL}?action=getTeacherMessages`);
        const data = await res.json();
        document.getElementById('msg-load').style.display = 'none';
        document.getElementById('msg-badge').style.display = 'none';
        localStorage.setItem('lastMsgCount', data.length);
        let h = "";
        data.reverse().forEach(m => {
            h += `<div class="msg-box"><b>Ø­Ù„Ù‚Ø©: ${m.circle}</b> <small>(${m.date})</small><p>${m.text}</p></div>`;
        });
        document.getElementById('msg-list').innerHTML = h || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.";
    }

    async function sendBroadcast() {
        const text = document.getElementById('bc-text').value;
        if(!text) return msg("Ø§ÙƒØªØ¨ Ù†ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹", "orange");
        msg("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...", "blue");
        await fetch(`${SCRIPT_URL}?action=sendAdminGlobalNote&note=${encodeURIComponent(text)}`, {method:'POST'});
        msg("ØªÙ… Ø§Ù„ØªØ¹Ù…ÙŠÙ… âœ…", "green");
        closeModal('broadcast-modal');
    }

    async function loadBlocked() {
        document.getElementById('blocked-load').style.display = 'block';
        const res = await fetch(`${SCRIPT_URL}?action=getBlockedStudents`);
        const data = await res.json();
        document.getElementById('blocked-load').style.display = 'none';
        let h = `<table class="report-table"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ù„Ù‚Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
        data.forEach(s => {
            h += `<tr><td>${s.name}</td><td>${s.circle}</td><td><button class="action-btn" style="background:#28a745; color:white;" onclick="handleStatus('${s.id}', 'Ø³Ù…Ø§Ø­')">Ø³Ù…Ø§Ø­</button><button class="action-btn" style="background:#dc3545; color:white;" onclick="handleStatus('${s.id}', 'ÙØµÙ„')">ÙØµÙ„</button></td></tr>`;
        });
        document.getElementById('blocked-list').innerHTML = data.length ? h + "</table>" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¬Ø§ÙˆØ²ÙŠÙ†.";
    }

    async function handleStatus(id, status) {
        if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„${status}ØŸ`)) return;
        await fetch(`${SCRIPT_URL}?action=updateStatus&id=${id}&status=${status}`, {method:'POST'});
        msg("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ…", "green"); loadBlocked();
    }

    async function runSearch(mode) {
        const q = document.getElementById('s-query').value;
        if(!q) return;
        document.getElementById('s-load').style.display = 'block';
        const res = await fetch(`${SCRIPT_URL}?action=searchStudent&query=${encodeURIComponent(q)}`);
        const data = await res.json();
        document.getElementById('s-load').style.display = 'none';
        let h = "";
        data.forEach(s => {
            h += `<div class="student-profile"><b>${s.name}</b> - ${s.circle}</div>`;
        });
        document.getElementById('s-res').innerHTML = h || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.";
        document.getElementById('btn-p-s').style.display = data.length ? 'block' : 'none';
    }

    async function doAttendance() {
        const id = document.getElementById('att-id').value;
        if(!id) return;
        document.getElementById('att-load').style.display = 'block';
        const row = [id, "Ø­Ø§Ø¶Ø±", new Date().toLocaleDateString(), new Date().toLocaleTimeString()];
        await fetch(`${SCRIPT_URL}?sheetName=Ø§Ù„Ø­Ø¶ÙˆØ±&data=${JSON.stringify(row)}`, {method:'POST'});
        document.getElementById('att-load').style.display = 'none';
        document.getElementById('att-id').value = "";
        msg("ØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ± âœ…", "green");
    }

    async function doRegister() {
        const d = [document.getElementById('r-id').value, document.getElementById('r-name').value, document.getElementById('r-class').value, 0, new Date().toLocaleDateString(), document.getElementById('r-phone').value, document.getElementById('r-father').value, document.getElementById('r-mother').value, document.getElementById('r-dob').value, document.getElementById('r-circle').value, document.getElementById('r-address').value, document.getElementById('r-family').value, document.getElementById('r-orphan').value];
        await fetch(`${SCRIPT_URL}?sheetName=Ø§Ù„Ø·Ù„Ø§Ø¨&data=${JSON.stringify(d)}`, {method:'POST'});
        msg("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ…", "green"); closeModal('reg-modal');
    }

    function doPrint(id) {
        document.getElementById('print-content').innerHTML = `<h2>ØªÙ‚Ø±ÙŠØ± Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø´ÙŠØ® Ø¹Ø·Ø§</h2>` + document.getElementById(id).innerHTML;
        window.print();
    }

    setInterval(checkNewMessages, 20000);
    checkNewMessages();
</script>
</body>
</html>
