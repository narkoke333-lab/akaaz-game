<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ (WebRTC)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; text-align: center; overflow: hidden; }
        h1 { margin: 10px; font-size: 1.2rem; text-shadow: 0 0 10px #0f0; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        #menu { display: flex; flex-direction: column; gap: 20px; justify-content: center; height: 100vh; }
        button { padding: 15px 30px; font-size: 1.2rem; background: #004400; color: #fff; border: 2px solid #0f0; cursor: pointer; border-radius: 10px; }
        button:hover { background: #0f0; color: #000; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø§Ù„Ù…Ø±Ø³Ù„) */
        #sender-panel { display: none; padding: 20px; }
        .id-box { background: #222; padding: 15px; border: 1px dashed #0f0; margin: 10px; font-size: 1.5rem; user-select: all; }
        #local-video { width: 50%; border: 1px solid #333; margin-top: 10px; opacity: 0.5; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) */
        #receiver-panel { display: none; height: 100vh; position: relative; }
        #remote-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; opacity: 0.6; }
        
        /* Ù…Ø´Ù‡Ø¯ Ø§Ù„Ù€ 3D */
        .scene { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; perspective: 1000px; z-index: 10; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.05s linear; }
        .face { position: absolute; width: 200px; height: 200px; left: 50px; top: 50px; border: 2px solid #0f0; background: rgba(0, 50, 0, 0.3); display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 2rem; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); color: #fff; }
        .front { transform: translateZ(100px); }
        .back { transform: rotateY(180deg) translateZ(100px); }
        .right { transform: rotateY(90deg) translateZ(100px); }
        .left { transform: rotateY(-90deg) translateZ(100px); }
        .top { transform: rotateX(90deg) translateZ(100px); }
        .bottom { transform: rotateX(-90deg) translateZ(100px); }

        input { padding: 10px; font-size: 1.2rem; text-align: center; width: 200px; }
        .overlay-ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„</h1>
        <button onclick="startSender()">ğŸ“± Ø£Ù†Ø§ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ)</button>
        <button onclick="startReceiver()">ğŸ’» Ø£Ù†Ø§ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©)</button>
    </div>

    <div id="sender-panel">
        <h2>ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
        <p>Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±:</p>
        <div class="id-box" id="my-id">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</div>
        <p id="status">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø°Ù†...</p>
        <video id="local-video" autoplay muted playsinline></video>
        <br><br>
        <button onclick="requestSensors()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø§Øª ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸš€</button>
    </div>

    <div id="receiver-panel">
        <video id="remote-video" autoplay playsinline></video>
        
        <div class="overlay-ui" id="connect-ui">
            <input type="text" id="target-id" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‡Ù†Ø§">
            <button onclick="connectToMobile()">Ø§ØªØµØ§Ù„</button>
        </div>

        <div class="scene">
            <div class="cube" id="cube">
                <div class="face front">CAM</div>
                <div class="face back">BACK</div>
                <div class="face right">R</div>
                <div class="face left">L</div>
                <div class="face top">TOP</div>
                <div class="face bottom">BTM</div>
            </div>
        </div>
    </div>

    <script>
        const peer = new Peer(); // Ø¥Ù†Ø´Ø§Ø¡ Ù‡ÙˆÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        let conn = null;
        
        // === Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (Ø§Ù„Ù…Ø±Ø³Ù„) ===
        function startSender() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('sender-panel').style.display = 'block';

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
            });

            // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØµÙ„ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
            peer.on('connection', (c) => {
                conn = c;
                document.getElementById('status').innerText = "ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±! âœ…";
            });
        }

        function requestSensors() {
            // 1. Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
            .then(stream => {
                document.getElementById('local-video').srcObject = stream;
                // Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
                peer.on('call', (call) => {
                    call.answer(stream); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø«
                });
            }).catch(err => alert("ÙØ´Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err));

            // 2. Ø·Ù„Ø¨ Ø§Ù„Ø¬ÙŠØ±ÙˆØ³ÙƒÙˆØ¨ (Ù…Ù‡Ù… Ù„Ù„Ø¢ÙŠÙÙˆÙ† ÙˆØ§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø§Ù„Ø­Ø¯ÙŠØ«)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') window.addEventListener('deviceorientation', handleOrientation);
                    }).catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            if(!conn) return;
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
            const data = {
                alpha: event.alpha, // Z
                beta: event.beta,   // X
                gamma: event.gamma  // Y
            };
            conn.send(data);
        }

        // === Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) ===
        function startReceiver() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('receiver-panel').style.display = 'block';
        }

        function connectToMobile() {
            const mobileId = document.getElementById('target-id').value;
            if(!mobileId) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");

            document.getElementById('connect-ui').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„

            // 1. Ø§ØªØµØ§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø¬ÙŠØ±ÙˆØ³ÙƒÙˆØ¨)
            const dataConn = peer.connect(mobileId);
            
            dataConn.on('open', () => {
                console.log("Data connection open");
            });

            dataConn.on('data', (data) => {
                // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…ÙƒØ¹Ø¨ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
                const cube = document.getElementById('cube');
                // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø©
                cube.style.transform = `rotateX(${data.beta}deg) rotateY(${data.gamma}deg) rotateZ(${data.alpha}deg)`;
            });

            // 2. Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§)
            // Ù†ØªØµÙ„ Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙ†Ø·Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const call = peer.call(mobileId, new MediaStream()); // Ù†Ø±Ø³Ù„ stream ÙØ§Ø±Øº ÙÙ‚Ø· Ù„ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø©
            
            call.on('stream', (remoteStream) => {
                const video = document.getElementById('remote-video');
                video.srcObject = remoteStream;
            });
        }
    </script>
</body>
</html>
